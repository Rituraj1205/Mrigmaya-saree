import{r as o,A as Q,C as Z,u as J,i as g,j as e,z as n}from"./index-a1a7f1c8.js";const x=d=>new Intl.NumberFormat("en-IN",{maximumFractionDigits:0}).format(d||0),$=[{value:"COD",label:"Cash on delivery (Pay to courier)"},{value:"UPI",label:"Pay now (GPay / PhonePe / UPI)"}],V="rzp_test_RjUFdd3BB4mysD",X=()=>new Promise(d=>{if(window.Razorpay)return d(!0);const i=document.createElement("script");i.src="https://checkout.razorpay.com/v1/checkout.js",i.onload=()=>d(!0),i.onerror=()=>d(!1),document.body.appendChild(i)});function se(){const{token:d,user:i}=o.useContext(Q),{cart:h,fetchCart:P}=o.useContext(Z),b=J(),[u,z]=o.useState("COD"),[y,F]=o.useState(!0),[S,k]=o.useState(!1),[j,R]=o.useState(""),[l,f]=o.useState(null),[A,O]=o.useState(!1),[s,m]=o.useState({name:(i==null?void 0:i.name)||"",phone:(i==null?void 0:i.mobile)||"",line1:"",line2:"",city:"",state:"",pincode:""}),[v,B]=o.useState("");o.useEffect(()=>{g.get("/settings/public").then(a=>{var t;typeof((t=a.data)==null?void 0:t.codEnabled)=="boolean"&&F(a.data.codEnabled)}).catch(()=>{})},[]),o.useEffect(()=>{!y&&u==="COD"&&z("UPI")},[y,u]);const N=o.useMemo(()=>h.reduce((a,t)=>{var r,c;return a+((((r=t.product)==null?void 0:r.discountPrice)||((c=t.product)==null?void 0:c.price)||0)*t.quantity||0)},0),[h]),C=(l==null?void 0:l.discount)||0,D=Math.max(0,N-C),I=Math.round(D*(u==="UPI"?.1:0)),_=Math.max(0,D-I),Y=o.useMemo(()=>y?$:$.filter(a=>a.value!=="COD"),[y]),q=()=>d?h.length?s.name.trim()?!s.phone||s.phone.replace(/\D/g,"").length<10?(n.error("Please enter a valid phone number"),null):s.line1.trim()?s.city.trim()?s.state.trim()?!s.pincode||s.pincode.replace(/\D/g,"").length<6?(n.error("Please enter a valid pincode"),null):{name:s.name.trim(),phone:s.phone.trim(),line1:s.line1.trim(),line2:s.line2.trim(),city:s.city.trim(),state:s.state.trim(),pincode:s.pincode.trim()}:(n.error("Please enter state"),null):(n.error("Please enter city"),null):(n.error("Please enter house/flat and street"),null):(n.error("Please enter recipient name"),null):(n.error("Cart is empty"),null):(b("/login"),null),T=async a=>{var r;const{data:t}=await g.post("/orders",{paymentMethod:"COD",shippingAddress:a,customerNote:v.trim(),couponCode:(l==null?void 0:l.code)||""},{headers:{Authorization:`Bearer ${d}`}});await P(),n.success(t.message||"Order placed"),b("/order-success",{state:{orderId:(r=t.order)==null?void 0:r._id,paymentMethod:"COD"}})},G=async a=>{var M,U,E;if(!await X()){n.error("Could not load Razorpay. Check your connection.");return}const{data:r}=await g.post("/orders/create",{shippingAddress:a,customerNote:v.trim(),couponCode:(l==null?void 0:l.code)||""},{headers:{Authorization:`Bearer ${d}`}}),c=r.razorpayOrder,p=r.order;new window.Razorpay({key:V,amount:c.amount,currency:c.currency,name:"Mrigmaya",description:((E=(U=(M=p==null?void 0:p.items)==null?void 0:M[0])==null?void 0:U.product)==null?void 0:E.name)||"Saree order",order_id:c.id,prefill:{name:a.name,contact:a.phone},handler:async w=>{try{await g.post("/orders/verify",{razorpay_payment_id:w.razorpay_payment_id,razorpay_order_id:w.razorpay_order_id,razorpay_signature:w.razorpay_signature},{headers:{Authorization:`Bearer ${d}`}}),await P(),n.success("Payment success"),b("/order-success",{state:{orderId:p==null?void 0:p._id,paymentMethod:"RAZORPAY"}})}catch(K){console.error(K),n.error("Payment verification failed. Contact support if charged.")}},modal:{ondismiss:()=>{n.error("Payment cancelled. You can try again.")}}}).open()},H=async()=>{var t,r;const a=q();if(a){l&&!l.code&&f(null);try{k(!0),u==="UPI"?await G(a):await T(a)}catch(c){console.error(c),n.error(((r=(t=c.response)==null?void 0:t.data)==null?void 0:r.msg)||"Could not place order")}finally{k(!1)}}},L=async()=>{var a,t;if(!j.trim()){n.error("Enter a coupon code");return}O(!0);try{const{data:r}=await g.post("/coupons/apply",{code:j.trim(),amount:N},{headers:{Authorization:`Bearer ${d}`}});f(r),n.success(`Coupon applied: -Rs. ${x(r.discount)}`)}catch(r){console.error(r),n.error(((t=(a=r.response)==null?void 0:a.data)==null?void 0:t.msg)||"Coupon not valid"),f(null)}finally{O(!1)}},W=()=>{R(""),f(null)};return h.length?e.jsxs("div",{className:"p-6 max-w-3xl mx-auto space-y-6 bg-[var(--bg)] text-[var(--ink)]",children:[e.jsxs("header",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.4em] text-[var(--accent)]/80",children:"Checkout"}),e.jsx("h1",{className:"text-3xl font-semibold text-[var(--primary)]",children:"Ready to place order?"}),e.jsx("p",{className:"text-[var(--ink)]/70 mt-2",children:"Select a payment option and confirm. You will receive order updates on WhatsApp/SMS."}),e.jsx("div",{className:"mt-4 flex flex-wrap gap-3 text-sm font-semibold",children:["Shipping","Payment","Review"].map((a,t)=>e.jsxs("div",{className:`flex items-center gap-2 px-3 py-2 rounded-full border ${t===0?"bg-[var(--primary-soft)]/70 border-[var(--primary-soft)] text-[var(--ink)]":"border-[var(--border)] text-[var(--muted)] bg-white/70"}`,children:[e.jsx("span",{className:`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${t===0?"bg-[var(--primary)] text-white":"bg-[var(--surface-muted)] text-[var(--muted)]"}`,children:t+1}),a]},a))})]}),e.jsxs("section",{className:"bg-white rounded-2xl shadow p-5 space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Your cart"}),h.map(a=>{var t,r,c,p;return e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-900",children:(t=a.product)==null?void 0:t.name}),e.jsxs("p",{className:"text-gray-500",children:["Qty: ",a.quantity]}),(a.selectedColor||a.selectedSize)&&e.jsxs("p",{className:"text-xs text-gray-500",children:[a.selectedColor&&e.jsxs("span",{children:["Color: ",a.selectedColor]}),a.selectedColor&&a.selectedSize&&e.jsx("span",{children:" â€¢ "}),a.selectedSize&&e.jsxs("span",{children:["Size: ",a.selectedSize]})]})]}),e.jsxs("span",{className:"font-semibold text-gray-900",children:["Rs."," ",x((((r=a.product)==null?void 0:r.discountPrice)||((c=a.product)==null?void 0:c.price)||0)*a.quantity)]})]},(p=a.product)==null?void 0:p._id)}),e.jsxs("div",{className:"flex items-center justify-between border-t pt-3 font-semibold text-gray-900",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["Rs. ",x(N)]})]}),e.jsxs("div",{className:"border rounded-xl p-3 bg-[#f8f5ff]",children:[e.jsx("label",{className:"text-sm font-semibold text-gray-900",children:"Have a coupon?"}),e.jsxs("div",{className:"mt-2 flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{value:j,onChange:a=>R(a.target.value),placeholder:"Enter code (e.g. FIRST200)",className:"border rounded-xl px-3 py-2 flex-1"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:L,disabled:A,className:"bg-pink-600 text-white px-4 py-2 rounded-xl text-sm font-semibold disabled:opacity-70",children:A?"Applying...":"Apply"}),l&&e.jsx("button",{onClick:W,className:"border border-gray-200 px-4 py-2 rounded-xl text-sm",children:"Remove"})]})]}),l&&e.jsxs("p",{className:"text-xs text-emerald-600 mt-2",children:["Applied ",l.code,": -Rs. ",x(l.discount)]})]}),C>0&&e.jsxs("div",{className:"flex items-center justify-between text-sm text-emerald-700",children:[e.jsx("span",{children:"Coupon discount"}),e.jsxs("span",{children:["-Rs. ",x(C)]})]}),u==="UPI"&&e.jsxs("div",{className:"flex items-center justify-between text-xs text-emerald-600",children:[e.jsx("span",{children:"Pay now discount (10%)"}),e.jsxs("span",{children:["-Rs. ",x(I)]})]}),e.jsxs("div",{className:"flex items-center justify-between border-t pt-3 font-semibold text-gray-900",children:[e.jsx("span",{children:"Total payable"}),e.jsxs("span",{children:["Rs. ",x(_)]})]})]}),e.jsxs("section",{className:"bg-white rounded-2xl shadow p-5 space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Delivery details"}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"Full name"}),e.jsx("input",{value:s.name,onChange:a=>m(t=>({...t,name:a.target.value})),className:"border rounded-xl px-3 py-2 w-full",placeholder:"Recipient name"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"Phone"}),e.jsx("input",{value:s.phone,onChange:a=>m(t=>({...t,phone:a.target.value.replace(/[^0-9+ ]/g,"")})),className:"border rounded-xl px-3 py-2 w-full",placeholder:"10-digit mobile"})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"Address"}),e.jsx("input",{value:s.line1,onChange:a=>m(t=>({...t,line1:a.target.value})),className:"border rounded-xl px-3 py-2 w-full",placeholder:"House / Flat, Street"})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"Landmark (optional)"}),e.jsx("input",{value:s.line2,onChange:a=>m(t=>({...t,line2:a.target.value})),className:"border rounded-xl px-3 py-2 w-full",placeholder:"Near temple, mall, etc."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"City"}),e.jsx("input",{value:s.city,onChange:a=>m(t=>({...t,city:a.target.value})),className:"border rounded-xl px-3 py-2 w-full",placeholder:"City"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"State"}),e.jsx("input",{value:s.state,onChange:a=>m(t=>({...t,state:a.target.value})),className:"border rounded-xl px-3 py-2 w-full",placeholder:"State"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"Pincode"}),e.jsx("input",{value:s.pincode,onChange:a=>m(t=>({...t,pincode:a.target.value.replace(/[^0-9]/g,"")})),className:"border rounded-xl px-3 py-2 w-full",placeholder:"6-digit pincode",maxLength:6})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-600",children:"Delivery note (optional)"}),e.jsx("textarea",{value:v,onChange:a=>B(a.target.value),className:"border rounded-xl px-3 py-2 w-full",rows:2,placeholder:"Gate code or delivery instructions"})]})]})]}),e.jsxs("section",{className:"bg-white rounded-2xl shadow p-5 space-y-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Payment method"}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs text-gray-600",children:[e.jsx("span",{className:"px-3 py-1 rounded-full bg-green-50 text-green-700 border border-green-100",children:"UPI accepted"}),y&&e.jsx("span",{className:"px-3 py-1 rounded-full bg-amber-50 text-amber-700 border border-amber-100",children:"COD available"}),e.jsx("span",{className:"px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100",children:"Secure Razorpay checkout"})]}),e.jsx("div",{className:"space-y-3",children:Y.map(a=>e.jsxs("label",{className:"flex items-center gap-3 border rounded-2xl px-4 py-3 cursor-pointer hover:border-pink-200",children:[e.jsx("input",{type:"radio",name:"payment",checked:u===a.value,onChange:()=>z(a.value)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-gray-900",children:a.label}),a.value==="UPI"&&e.jsx("p",{className:"text-xs text-gray-500",children:"Pay now and get 10% instant discount. We will open your phone's UPI app with the payable amount."})]})]},a.value))}),e.jsx("button",{onClick:H,disabled:S,className:"w-full bg-pink-600 text-white px-4 py-3 rounded-full font-semibold disabled:opacity-70",children:S?"Placing order...":`Place order (Rs. ${x(_)})`}),u==="COD"?e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Pay cash or UPI to the courier when your saree arrives."}):e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"10% instant discount applied. After tapping place order we open the UPI app. Complete the payment to confirm."}),e.jsxs("div",{className:"flex flex-wrap gap-2 text-xs text-gray-600 justify-center pt-2",children:[e.jsx("span",{className:"px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100",children:"Delivery estimate: 4-7 business days"}),e.jsx("span",{className:"px-3 py-1 rounded-full bg-sky-50 text-sky-700 border border-sky-100",children:"Free 7-day returns"})]})]})]}):e.jsxs("div",{className:"p-6 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Checkout"}),e.jsx("p",{className:"mt-4 text-gray-500",children:"Your cart is empty. Add sarees to continue."})]})}export{se as default};
